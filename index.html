<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Viewer</title>
    <script>
        /* eslint-env browser */

        let pc = new RTCPeerConnection({
            iceServers: [
                {
                    urls: 'stun:stun.l.google.com:19302'
                }
            ]
        })
        let log = msg => {
            document.getElementById('div').innerHTML += msg + '<br>'
        }

        pc.ontrack = function (event) {
            var el = document.createElement(event.track.kind)
            el.srcObject = event.streams[0]
            el.autoplay = true
            el.controls = false
            document.getElementById('remoteVideos').appendChild(el)
        }

        pc.oniceconnectionstatechange = e => log(pc.iceConnectionState)
        pc.onicecandidate = event => {
            if (event.candidate === null) {
                document.getElementById('localSessionDescription').value = btoa(JSON.stringify(pc.localDescription))
            }
        }

        let dataChannel = pc.createDataChannel("textChannel", {
            protocol: "text"
        });

        dataChannel.onopen = () => {
            console.log("DataChannel is open and ready to be used.");
        }

        dataChannel.onmessage = (event) => {
            log(`Message from server: ${event.data}`);
        }

        dataChannel.onclose = () => {
            console.log("The data channel has been closed.");
        }

        // Offer to receive 1 audio, and 2 video tracks
        pc.addTransceiver('audio', {'direction': 'recvonly'})
        pc.addTransceiver('video', {'direction': 'recvonly'})
        pc.addTransceiver('video', {'direction': 'recvonly'})
        pc.createOffer().then(d => pc.setLocalDescription(d)).catch(log)

        window.startSession = () => {
            let sd = document.getElementById('remoteSessionDescription').value
            if (sd === '') {
                return alert('Session Description must not be empty')
            }

            try {
                pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(atob(sd))))
            } catch (e) {
                alert(e)
            }
        }

        window.sendMessage = () => {
            let message = document.getElementById('messageInput').value;
            console.log("1",message);
            if (message === '') {
                return alert('Message must not be empty');
            }
            console.log("2",message);
            dataChannel.send(message);
            log(`Sent message: ${message}`);
            console.log("3",message);
        }

    </script>
    <style>
        textarea {
            width: 500px;
            min-height: 75px;
        }
    </style>
</head>
<body>
Browser base64 Session Description<br />
<textarea id="localSessionDescription" readonly="true"></textarea> <br />

Golang base64 Session Description<br />
<textarea id="remoteSessionDescription"> </textarea> <br/>
<button onclick="window.startSession()"> Start Session </button><br />

<br />

<br />
Send a message to the server:<br />
<input type="text" id="messageInput" placeholder="Type your message here">
<button onclick="window.sendMessage()">Send Message</button><br />

Video<br />
<div id="remoteVideos" style="background:none;height:1280px;width:640px"></div> <br />

Logs<br />
<div id="div"></div>

</body>
</html>